<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/><title>Contact — Undefeatables</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/><link rel="stylesheet" href="css/style.css" />
  <style>
    /* Small status styling to match theme */
    #contact-status { display:inline-block; margin-left:.6rem; color:var(--muted); }
    #contact-status.success { color: #b8f0c1; font-weight:700; }
    #contact-status.error { color: #ffb4b4; font-weight:700; }
  </style>
</head>
<body>
  <main class="container">
    <section style="margin-top:1rem">
      <h2>Contact</h2>
      <p class="small">Questions, collaborations, or partnership inquiries — send us a message.</p>

      <form class="contact" id="contact-form">
        <label>Name</label><input type="text" placeholder="Full name" id="contact-name" required />
        <label>Email</label><input type="email" placeholder="you@domain.com" id="contact-email" required />
        <label>Phone</label><input type="tel" placeholder="+91 9XXXXXXXXX" id="contact-phone" />
        <label>Subject</label><input type="text" placeholder="Short subject" id="contact-subject" />
        <label>Message</label><textarea placeholder="Tell us what you need..." id="contact-message" required></textarea>
        <div style="display:flex;gap:.6rem;align-items:center">
          <button type="submit" class="btn" id="contact-submit">Send Message</button>
          <span class="small" id="contact-status"></span>
        </div>
      </form>
    </section>
  </main>

  <script src="js/common.js" defer></script>
  <script src="js/script.js" defer></script>

  <!-- Firestore submit logic -->
  <script type="module">
    // Replace or keep the firebaseConfig below - copied from your index page
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBJ79YElN89gT4U-4z339kAE4JjnPobMr0",
      authDomain: "undef-wait-v1.firebaseapp.com",
      projectId: "undef-wait-v1",
      storageBucket: "undef-wait-v1.appspot.com",
      messagingSenderId: "766114938290",
      appId: "1:766114938290:web:8f2b25d5ac00cb0f16f8ab",
      measurementId: "G-YG1T6LZ6F6"
    };

    let db = null;
    try {
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
    } catch (err) {
      console.warn('Firestore init failed, will use local fallback only:', err);
      db = null;
    }

    // Helpers
    const form = document.getElementById('contact-form');
    const nameEl = document.getElementById('contact-name');
    const emailEl = document.getElementById('contact-email');
    const phoneEl = document.getElementById('contact-phone');
    const subjectEl = document.getElementById('contact-subject');
    const messageEl = document.getElementById('contact-message');
    const submitBtn = document.getElementById('contact-submit');
    const statusEl = document.getElementById('contact-status');

    function isValidEmail(v){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v || ''); }

    function fallbackStoreContact(payload){
      const key = 'ud_contacts_v1';
      const arr = JSON.parse(localStorage.getItem(key) || '[]');
      arr.push(payload);
      localStorage.setItem(key, JSON.stringify(arr));
    }

    function setStatus(text, type){
      statusEl.textContent = text || '';
      statusEl.classList.remove('success','error');
      if(type) statusEl.classList.add(type);
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      setStatus('', null);

      const name = (nameEl.value || '').trim();
      const email = (emailEl.value || '').trim();
      const phone = (phoneEl.value || '').trim();
      const subject = (subjectEl.value || '').trim();
      const message = (messageEl.value || '').trim();

      if(!name){ setStatus('Please enter your name.', 'error'); nameEl.focus(); return; }
      if(!email || !isValidEmail(email)){ setStatus('Please enter a valid email.', 'error'); emailEl.focus(); return; }
      if(!message){ setStatus('Please add a short message.', 'error'); messageEl.focus(); return; }

      submitBtn.disabled = true;
      const oldTxt = submitBtn.innerText;
      submitBtn.innerText = 'Sending...';
      setStatus('Sending...', null);

      let saved = false;

      // Try Firestore (client). Note: will only work if your rules permit client writes.
      if(db){
        try {
          await addDoc(collection(db, 'contacts'), {
            name,
            email: email.toLowerCase(),
            phone: phone || null,
            subject: subject || null,
            message,
            createdAt: serverTimestamp(),
            source: 'site'
          });
          saved = true;
          setStatus('Message sent — thank you!', 'success');
        } catch (err) {
          console.warn('Firestore add failed:', err);
          // Handle permission errors (missing/insufficient permissions)
          if(err && err.code && err.code.includes('permission')) {
            setStatus('Could not send (permission). Using local fallback.', 'error');
          } else {
            setStatus('Failed to send — using local fallback.', 'error');
          }
        }
      }

      // Optional: try server endpoint if you have one (uncomment & set URL)
      if(!saved){
        try {
          // const res = await fetch('/api/contacts', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({name,email,phone,subject,message}) });
          // if(res.ok){ saved = true; setStatus('Message sent — thank you!', 'success'); }
        } catch(err){
          console.warn('Server fallback failed:', err);
        }
      }

      // Final fallback: store locally so you don't lose messages during development
      if(!saved){
        fallbackStoreContact({
          name, email: email.toLowerCase(), phone, subject, message, at: new Date().toISOString()
        });
        if(!statusEl.textContent || statusEl.classList.contains('error')) {
          setStatus('Saved locally (demo). We will migrate when backend is ready.', 'success');
        }
      }

      submitBtn.disabled = false;
      submitBtn.innerText = oldTxt;
      form.reset();

      // keep success visible for a few seconds
      setTimeout(()=> setStatus('', null), 7000);
    });
  </script>
</body>
</html>
