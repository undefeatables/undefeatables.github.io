<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/><title>Contact — Undefeatables</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/><link rel="stylesheet" href="css/style.css" />
  <style>
    /* small status styles to match page theme */
    #contact-status { display:inline-block; margin-left:.6rem; color:var(--muted); }
    #contact-status.success { color: #b8f0c1; font-weight:700; }
    #contact-status.error { color: #ffb4b4; font-weight:700; }
    /* keep form responsive */
    .contact input, .contact textarea { width:100%; box-sizing:border-box; }
    .contact { display:grid; gap:.5rem; max-width:720px; }
  </style>
</head>
<body>
  <main class="container">
    <section style="margin-top:1rem">
      <h2>Contact</h2>
      <p class="small">Questions, collaborations, or partnership inquiries — send us a message.</p>

      <form class="contact" id="contact-form">
        <label>Name</label><input type="text" placeholder="Full name" id="contact-name" required />
        <label>Email</label><input type="email" placeholder="you@domain.com" id="contact-email" required />
        <label>Phone</label><input type="tel" placeholder="+91 9XXXXXXXXX" id="contact-phone" />
        <label>Subject</label><input type="text" placeholder="Short subject" id="contact-subject" />
        <label>Message</label><textarea placeholder="Tell us what you need..." id="contact-message" required></textarea>
        <div style="display:flex;gap:.6rem;align-items:center">
          <button type="submit" class="btn" id="contact-submit">Send Message</button>
          <span class="small" id="contact-status" role="status" aria-live="polite"></span>
        </div>
      </form>
    </section>
  </main>

  
  <script src="js/script.js" defer></script>

  <!-- Firestore submit logic (modular SDK) -->
  <script type="module">
    // Imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    // Firebase config (copied from your site)
    const firebaseConfig = {
      apiKey: "AIzaSyBJ79YElN89gT4U-4z339kAE4JjnPobMr0",
      authDomain: "undef-wait-v1.firebaseapp.com",
      projectId: "undef-wait-v1",
      storageBucket: "undef-wait-v1.appspot.com",
      messagingSenderId: "766114938290",
      appId: "1:766114938290:web:8f2b25d5ac00cb0f16f8ab",
      measurementId: "G-YG1T6LZ6F6"
    };

    // Elements
    const form = document.getElementById('contact-form');
    const nameEl = document.getElementById('contact-name');
    const emailEl = document.getElementById('contact-email');
    const phoneEl = document.getElementById('contact-phone');
    const subjectEl = document.getElementById('contact-subject');
    const messageEl = document.getElementById('contact-message');
    const submitBtn = document.getElementById('contact-submit');
    const statusEl = document.getElementById('contact-status');

    // Util: email validator
    function isValidEmail(v){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v || ''); }

    // Local fallback for development (stores submissions in localStorage)
    function fallbackStoreContact(payload){
      const key = 'ud_contacts_v1';
      const arr = JSON.parse(localStorage.getItem(key) || '[]');
      arr.push(payload);
      localStorage.setItem(key, JSON.stringify(arr));
    }

    function setStatus(text, type){
      statusEl.textContent = text || '';
      statusEl.classList.remove('success','error');
      if(type) statusEl.classList.add(type);
    }

    // Initialize Firestore client (if possible). If rules block client writes, addDoc will throw and we'll fallback.
    let db = null;
    try {
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
    } catch (err) {
      console.warn('Firestore init failed, using local fallback only:', err);
      db = null;
    }

    // Prevent double submit
    let inflight = false;

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (inflight) return;

      setStatus('', null);

      const name = (nameEl.value || '').trim();
      const email = (emailEl.value || '').trim();
      const phone = (phoneEl.value || '').trim();
      const subject = (subjectEl.value || '').trim();
      const message = (messageEl.value || '').trim();

      if (!name) { setStatus('Please enter your name.', 'error'); nameEl.focus(); return; }
      if (!email || !isValidEmail(email)) { setStatus('Please enter a valid email.', 'error'); emailEl.focus(); return; }
      if (!message) { setStatus('Please add a short message.', 'error'); messageEl.focus(); return; }

      inflight = true;
      submitBtn.disabled = true;
      const oldText = submitBtn.innerText;
      submitBtn.innerText = 'Sending...';
      setStatus('Sending...', null);

      let saved = false;

      // 1) Try client-side Firestore write (works only if rules allow)
      if (db) {
        try {
          await addDoc(collection(db, 'contacts'), {
            name,
            email: email.toLowerCase(),
            phone: phone || null,
            subject: subject || null,
            message,
            createdAt: serverTimestamp(),
            source: 'site'
          });
          saved = true;
          setStatus('Message sent — thank you!', 'success');
        } catch (err) {
          console.warn('Firestore add failed:', err);
          // Permission error or other — fall through to fallback
          if (err && err.code && (err.code.includes('permission') || err.code.includes('unauthenticated'))) {
            setStatus('Could not send (permission). Using local fallback.', 'error');
          } else {
            setStatus('Failed to send — using local fallback.', 'error');
          }
        }
      }

      // 2) Optional server endpoint fallback (uncomment and set URL if you have a server)
      if (!saved) {
        try {
          // const res = await fetch('/api/contacts', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ name, email, phone, subject, message }) });
          // if (res && res.ok) { saved = true; setStatus('Message sent — thank you!', 'success'); }
        } catch (err) {
          console.warn('Server fallback failed:', err);
        }
      }

      // 3) Final fallback: localStorage
      if (!saved) {
        fallbackStoreContact({
          name,
          email: email.toLowerCase(),
          phone,
          subject,
          message,
          at: new Date().toISOString()
        });
        // If status already shows an error message, upgrade to a success/fallback note
        setStatus('Saved locally (demo). We will migrate when backend is ready.', 'success');
      }

      // reset UI
      submitBtn.disabled = false;
      submitBtn.innerText = oldText;
      inflight = false;
      form.reset();

      // clear status after a bit
      setTimeout(() => setStatus('', null), 7000);
    });
  </script>
</body>
</html>
